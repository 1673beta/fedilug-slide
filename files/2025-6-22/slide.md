---
marp: true
title: サーバー関連やらかしまとめ 2023〜2025
paginate: true
author: Esurio
theme: default
---

<!-- _class: lead-->
# サーバー関連やらかしまとめ 2023〜2025
Esurio(@esurio1673@c.koliosky.com)

---

# 自己紹介

名前: Esurio
SNS: @esurio1673@c.koliosky.com
ディストリ: Fedora
言語: Typescript, Rust
ソフトウェア: CherryPick(forked), Hollo
近況: 引っ越し大変

---

# 近況について

---

### 大学受かった！
2025.4.3頃 半ばやけくそで海外の大学に出願したら、なんか受かった

### 引っ越しつらい
2025.5〜現在進行形 家決まらない、eSIM対応端末がない、お金が飛んでく

### そもそも行ける?
現在進行形 大学側のやらかしでTRP(一時滞在許可)の審査が止まってるらしい?

### サーバーで色々やらかし
2025.6.13 サーバーの引っ越し中にやらかし

---

## 来月7月4日で鯖缶3年目突入
## なので2023年から2025年現在までのやらかしをまとめてみた

---

# 2025年(現時点まで)

---

### 2025年総合
管理しきれないほどAPubサーバーを立ててしまった
- 時期: 2024年後半から2025年6月まで
- 原因: おさまらないので後述
- 対応: 2025年6月までにサーバーを整理

---

### なぜサーバーを立てすぎたのか?
- 2024年9月末頃、Holloが登場
  - 他のAPubサーバーのソフトウェアも気になった

- Issueを建てる際に、forkのバージョンだと開発者が受け付けてくれなかった
  - ので、forkしてないバージョンのサーバーも建てる必要があった

---

### 2025年6月13日
`pg_restore`の打ち間違えで12時間以上のダウンタイムを発生させた

- 原因: `pg_restore -d db_name dump.sql`
- 対応: `pg_restore -v -h localhost -p 5432 -U postgres -d db_name dump.sql`

今回のやらかしだと、`pg_restore`は無限にコマンドを実行し続けリストアされない

---

### 2025年4月頃
突然Valkeyのあるインスタンスのデータが吹っ飛ぶ

- 原因: systemd環境下で無理やりValkeyを複数プロセス起動していたこと? 詳細は不明
- 影響: 通知消えた、タイムライン空になった
- 対応: FTTを切ってDBからタイムラインを取得するように

---

# 2024年

---

### 2024年7月
DBマイグレーションのやらかし
- 原因: 過去の自分が同じ機能を実装しようとして、コードだけrevertした
- 対応: `ALTER TABLE DROP COLUMN`でカラムを削除後、再マイグレーション

---

### 2024年3月
Redisに接続できない
- 原因: 何かしらバックエンドのコードに問題があった
- 影響: 連合できなくなった
- 対応: **コードだけrevertした**

---

# 2023年

---

### 2023年8月初頭?
Misskeyのアップデートに失敗
- 原因: 記録がないのでわからない
- 対応: 確かサーバー丸ごと直近のバックアップから復元した

---

### 2023年時期不明
`サーバーのIPv4アドレス:3000`で直接アクセスできてしまった
- 原因: ufwの設定ミス
- 対応: ufwとnginxの設定を見直した

---

## まとめ

慎重な運用を！！！
迂闊にフォークに手を出さない！！！(2024年11月の勉強会のスライド参照)
